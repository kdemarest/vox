<!DOCTYPE HTML>
<html>
<head>
<title>Vox - a test bed</title>

<!-- Character encoding -->
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<!-- Stylesheet -->
<link href="style/main.css" rel="stylesheet" type="text/css">

<!-- Modules -->
<script src="js/glMatrix-1.2.min.js" type="text/javascript"></script>
<script src="js/utilModule.js" type="text/javascript"></script>
<script src="js/utilities.js" type="text/javascript"></script>
<script src="js/data.js" type="text/javascript"></script>
<script src="js/map.js" type="text/javascript"></script>
<script src="js/mapMaker.js" type="text/javascript"></script>
<script src="js/light.js" type="text/javascript"></script>
<script src="js/world.js" type="text/javascript"></script>
<script src="js/blocks.js" type="text/javascript"></script>
<script src="js/helpers.js" type="text/javascript"></script>
<script src="js/render.js" type="text/javascript"></script>
<script src="js/controls.js" type="text/javascript"></script>
<script src="js/body.js" type="text/javascript"></script>
<script src="js/viewMaterial.js" type="text/javascript"></script>
<script src="js/player.js" type="text/javascript"></script>

<script type="text/javascript">
Module.add( 'main', ()=> {

	let globalMapString = ``+
	`############################################\n`+
	`#.....######################################\n`+
	`#####+##..B.........ttttttttttttttttt#######\n`+
	`##.................########::::#####tt######\n`+
	`##....t..::.N.......##...####:::######t#####\n`+
	`##....%..::NCN......##...#::::::##:###t#####\n`+
	`##.........N.....-:::-..:::::::##::###t#####\n`+
	`##...........###+#::::..::::::::::::.#t#####\n`+
	`##..444......###.:::::..:::::::::::#.#t#####\n`+
	`##..444......==..:::::&#::::::::::::...#####\n`+
	`##...4...#.#####.-:::-.::::::::::::.....####\n`+
	`##www4www#.#¥.¥#........:::::::::::.......##\n`+
	`##www4ww##.#¥¥¥#........#::::::::::.......##\n`+
	`##www4ww##.#¥¥¥#........#::::::::::.......##\n`+
	`##wwwwww##.&#..#..N.......::::::::...MM...##\n`+
	`###wwww####.&#.#.NCN.......::::::.##.MM...##\n`+
	`###ww#######...#..N...............##......##\n`+
	`##########.###&#####+######+####..........##\n`+
	`###.......##...................##.-:::-...##\n`+
	`###...###......................###:::::...##\n`+
	`###...######...NNN......#+#....###:::::...##\n`+
	`#######&........U.......+I+....###:::::...##\n`+
	`######&.####..C.°.C.....#+#.......-:::-...##\n`+
	`######.##¥¥#............................####\n`+
	`######.#.¥.#............................####\n`+
	`######...¥¥#......2............C........####\n`+
	`############.....2::22...........N......####\n`+
	`##########......2:::::2........°UN.....#####\n`+
	`########.......2:::::::2.........N.....#####\n`+
	`######..........::::::::2......C.......#####\n`+
	`#####........22:::::::::2.............######\n`+
	`#####........:::::::::::2.............######\n`+
	`###....W.W..2::::::::::::.....-:::-..#######\n`+
	`##....W.WW...2:::::::::::2....:::::..#######\n`+
	`##...W.W......2:::::::::2.....:::::.....####\n`+
	`##....W..W.....2:::.:::2......:::::......###\n`+
	`##...W.W........2:2.222....N..-:::-.....####\n`+
	`####........N....22.......NCN.......MM..####\n`+
	`######.....NCN.............N..MM....MM..####\n`+
	`#######.....N..##.............MM.........###\n`+
	`##########.....##.####...................###\n`+
	`##########......#######..##..............###\n`+
	`##############.########..##..............###\n`+
	`############################################\n`
	;

	let Tile = {
		UNKNOWN: '?'
	}

	let SymbolToType = {
		'#': {
			isWall: true
		},
		'.': {
			isFloor: true,
			block: BLOCK.DIRT
		},
		'+': {
			isDoor: true
		},
		':': {
			isPit: true
		},
		'4': {
			isFloor: true,
			block: BLOCK.WOOD
		},
		'2': {
			isFloor: true,
			block: BLOCK.LAVA
		},
		't': {
			isTunnel: true
		},
		'=': {
			isWindow: true,
		},
		'w': {
			isPit: true,
			isWater: true,
		},
		'*': {
			isLight: true,
			isFloor: true,
			isSingular: true
		},
		'%': {
			isSpawn: true,
			isFloor: true
		},

	}
	return {
		Tile: Tile,
		Direction: Direction,
		SymbolToType: SymbolToType,
		globalMapString: globalMapString
	}

});
</script>

</head>

<body oncontextmenu="return false">
<!-- Render surface -->
<canvas id="renderSurface"></canvas>

<!-- Material selection -->
<table id="materialSelector">
	<tr></tr>
</table>

<!-- Initialisation code -->
<script type="text/javascript">

Module.add( 'playerControls', ()=> {

	class PlayerControls extends Controls {
		constructor(canvas,player) {
			super(canvas,player);

			this.addListener();
			this.pointerLockRequest();
			this.keyDef['w'] = this.keyDef['W'] =	(target,value) => { target.forward = value; }
			this.keyDef['s'] = this.keyDef['S'] =	(target,value) => { target.forward = -value; }
			this.keyDef['a'] = this.keyDef['A'] =	(target,value) => { target.sideways = value; }
			this.keyDef['d'] = this.keyDef['D'] =	(target,value) => { target.sideways = -value; }
			this.keyDef['c'] = this.keyDef['C'] =	(target,value) => {
				if( value ) {
					if( target.crawl && !target.mayExitCrawl() ) {
						return;
					}

					if( target.crouch ) { target.crawl = true; target.crouch = false; }
					else { target.crawl = false; target.crouch = true; }
				}
			}
			this.keyDef[' '] = (target,value) => {
				if( value ) {
					if( target.crawl && !target.mayExitCrawl() ) {
						return;
					}

					target.crouch = false;
					target.crawl = false;
					target.jump = true;
				}
			}
			this.keyDef['Shift'] = (target,value) => {
				if( !target.sprint && target.crouch ) {
					target.crouch = false;
				}
				if( !target.sprint && target.crawl ) {
					if( !target.mayExitCrawl() ) {
						return;
					}
					target.crawl = false;
				}
				target.sprint = target.crouch || target.crawl ? false : !!value;
			}
			this.mouseDef.move = (target,dx,dy) => {
				target.addYaw(dx);
				target.addPitch(-dy);
			}
			this.mouseDef.click = (target,rmb) => {
				target.doBlockAction( canvas.width/2, canvas.height/2, !rmb, (...args) => canvas.renderer.pickAt(...args) );
			}
		}
	}

	return {
		PlayerControls: PlayerControls
	}

});

window.addEventListener('DOMContentLoaded', function(){
	Module.realize();

	Random.Pseudo.seed(12345);

	let mapMaker = new MapMaker(globalMapString);
	let world = new World();
	world.init(mapMaker.map.xLen,mapMaker.map.yLen,16);

	world.createFlatWorld( 16 );

	mapMaker.makeIntoWorld(world);

	
	// Set up renderer
	var render = new Renderer( "renderSurface" );
	render.setWorld( world, 8 );
	render.setPerspective( 60, 0.01, 200 );
	
	// Create new local player
	let player = new Player();
	player.body.setWorld( world );
	player.viewMaterial.setMaterialSelector( "materialSelector" );

	let canvas = document.getElementById('renderSurface');
	let controls = new PlayerControls(canvas,player.body);


	window.tickCall = function() {
		var time = new Date().getTime() / 1000.0;
		
		// Update local player
		player.body.update();
		
		// Build a chunk
		render.buildChunks( 1 );
		//render.buildWorld();
		
		// Draw world
		render.setCamera( player.body.getEyePos().toArray(), player.body.angles );
		render.draw();
	}

	window.tick = function() {
		window.tickCall();
		window.requestAnimationFrame(window.tick)
	}

	window.requestAnimationFrame(window.tick);
	
});

</script>
</body>
</html>